<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.docmall.demo.mapper.BoardMapper">

	<insert id="write" parameterType="com.docmall.demo.domain.BoardVO">
	
		INSERT INTO
			board(bno, title, content, writer)
		VALUES
			(SEQ_BOARD.NEXTVAL, #{title}, #{content}, #{writer})
				
	</insert>

	<select id="list" resultType="com.docmall.demo.domain.BoardVO">
		SELECT 
			bno, title, content, writer, regdate, updatedate, viewcount
		FROM 
			board 
		ORDER BY 
			bno DESC
	</select>


	<!-- 검색조건(2곳에서 사용/목록: listWithPaging, 총데이터 개수: getTotalCount) 따로 만듬 -->
	<!-- 검색종류(제목 또는 작성자 또는 내용) 선택. "T","W","C" -->
	<sql id="criteria">
		<trim prefix= "(" suffix=") AND" prefixOverrides="OR" >
			<!-- 페이지에서 들어온 검색옵션과 검색내용은 각각 Criteria클래스의 type와 keyword로 들어간다. 여기 아래에서 해당 변수를 가져올땐 getter로 사용한다.
				 롬복으로 Criteria의 getter를 사용하고 있었는데 그것과 별개로 원하는 기능(typeArr)의 getter을 만들어주자.-->
			<!-- 중복검색기능이 없었으면 아래 foreach구문은 안들어 갔음. -->
			<foreach collection="typeArr" item="type"> <!-- typeArr라고 쓰면 getTypeArr메서드로 인식된다. 값이 3번(T,W,C) 들어오므로 3번 작동된다. -->
				<trim prefix="OR">
					<choose>
						<when test="type == 'T'.toString()">
							title like '%' || #{keyword} || '%'					
						</when>
						<when test="type == 'W'.toString()">
							writer like '%' || #{keyword} || '%'
						</when>
						<when test="type == 'C'.toString()">
							content like '%' || #{keyword} || '%'
						</when>
					</choose>
				</trim>
			</foreach>
		</trim>
	</sql>

	<!-- 공통사항: 검색조건 추가 -->
	<select id="listWithPaging" resultType="com.docmall.demo.domain.BoardVO" parameterType="com.docmall.demo.dto.Criteria">
				SELECT  
			bno, title, content, writer, regdate, updatedate, viewcount
		FROM (
	    	SELECT /*+ INDEX_DESC(board PK_BOARD) */
	        	ROWNUM AS RN, bno, title, content, writer, regdate, updatedate, viewcount
	    	FROM 
	        	board  
	    	WHERE 
	    	<include refid="criteria"></include>
	    <![CDATA[
	    	ROWNUM <= (#{pageNum} * #{amount}) 
	    ]]>
	    	)
		WHERE 
			RN > (#{pageNum} - 1) * #{amount} 
			
	</select> 		<!-- #{pageNum} 쓸땐 변수명을 썼지만 get메서드가 작동되고 있다. -->

	<!-- 공통사항: 검색조건 추가 -->
	<select id="getTotalCount" resultType="int">
		SELECT
			COUNT(*)
		FROM
			board
		WHERE
			<include refid="criteria"></include> <!-- 사용자가 검색을 사용하지 않으면 값이 넘어오지 않아 이 구문 자체가 생성되지 않는다. 그럼 where절까지만 작성디고 끊기는데 그럼 에러 발생함. -->
	    	bno > 0 	<!-- bno > 0을 쓰면 위 구문이 생성되지 않아도 에러가 발생하지 않는다. -->
	    	
			
	</select>
	
	
	<update id="readCount" parameterType="Long">
		UPDATE
			board
		SET
		 	viewcount = viewcount + 1
		WHERE
			bno = #{bno}
	</update>


	<select id="get" resultType="com.docmall.demo.domain.BoardVO" parameterType="Long">
		SELECT 
			bno, title, content, writer, regdate, updatedate, viewcount
		FROM 
			board 
		WHERE 
			bno = #{bno}
	</select>

	<update id="modify" parameterType="com.docmall.demo.domain.BoardVO">
		UPDATE 
			board 
   		SET 
   			title = #{title}, 
   			content = #{content}, 
   			updatedate = sysdate
		WHERE 
			bno = #{bno}
	</update>

	<delete id="delete" parameterType="Long">
		DELETE FROM
			board
		WHERE
			bno = #{bno}	
	</delete>






</mapper>
